<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>optimize优化 | Weblog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/weblog/icon.png">
    <meta name="description" content="王贺楠的个人博客">
    
    <link rel="preload" href="/weblog/assets/css/0.styles.570b819f.css" as="style"><link rel="preload" href="/weblog/assets/js/app.eefccb8e.js" as="script"><link rel="preload" href="/weblog/assets/js/2.dbfb7c6a.js" as="script"><link rel="preload" href="/weblog/assets/js/44.47622ca8.js" as="script"><link rel="prefetch" href="/weblog/assets/js/10.f8c2c72b.js"><link rel="prefetch" href="/weblog/assets/js/11.d4e327d9.js"><link rel="prefetch" href="/weblog/assets/js/12.ee2dc6a7.js"><link rel="prefetch" href="/weblog/assets/js/13.a3a3b499.js"><link rel="prefetch" href="/weblog/assets/js/14.ead09c7e.js"><link rel="prefetch" href="/weblog/assets/js/15.f5c6f95a.js"><link rel="prefetch" href="/weblog/assets/js/16.04afe6fc.js"><link rel="prefetch" href="/weblog/assets/js/17.382c7d13.js"><link rel="prefetch" href="/weblog/assets/js/18.52eea6bd.js"><link rel="prefetch" href="/weblog/assets/js/19.30e45ce3.js"><link rel="prefetch" href="/weblog/assets/js/20.b8483ab0.js"><link rel="prefetch" href="/weblog/assets/js/21.3c184d9a.js"><link rel="prefetch" href="/weblog/assets/js/22.8af109a2.js"><link rel="prefetch" href="/weblog/assets/js/23.ed5c0b8a.js"><link rel="prefetch" href="/weblog/assets/js/24.14ea4201.js"><link rel="prefetch" href="/weblog/assets/js/25.1f3ae49b.js"><link rel="prefetch" href="/weblog/assets/js/26.674fa537.js"><link rel="prefetch" href="/weblog/assets/js/27.7708290f.js"><link rel="prefetch" href="/weblog/assets/js/28.253b6864.js"><link rel="prefetch" href="/weblog/assets/js/29.cf658570.js"><link rel="prefetch" href="/weblog/assets/js/3.f10b48a9.js"><link rel="prefetch" href="/weblog/assets/js/30.ecea30b5.js"><link rel="prefetch" href="/weblog/assets/js/31.353916dc.js"><link rel="prefetch" href="/weblog/assets/js/32.70c471b8.js"><link rel="prefetch" href="/weblog/assets/js/33.2046d5ff.js"><link rel="prefetch" href="/weblog/assets/js/34.d65fe706.js"><link rel="prefetch" href="/weblog/assets/js/35.1e4bba7e.js"><link rel="prefetch" href="/weblog/assets/js/36.c76be612.js"><link rel="prefetch" href="/weblog/assets/js/37.580f62e9.js"><link rel="prefetch" href="/weblog/assets/js/38.f7726144.js"><link rel="prefetch" href="/weblog/assets/js/39.1e2c12f4.js"><link rel="prefetch" href="/weblog/assets/js/4.89565c71.js"><link rel="prefetch" href="/weblog/assets/js/40.e1b6b8fe.js"><link rel="prefetch" href="/weblog/assets/js/41.e6433e8e.js"><link rel="prefetch" href="/weblog/assets/js/42.fb769ab0.js"><link rel="prefetch" href="/weblog/assets/js/43.b382479b.js"><link rel="prefetch" href="/weblog/assets/js/45.1387ff67.js"><link rel="prefetch" href="/weblog/assets/js/46.ea8e0fcf.js"><link rel="prefetch" href="/weblog/assets/js/47.6a9a93a1.js"><link rel="prefetch" href="/weblog/assets/js/48.76977a18.js"><link rel="prefetch" href="/weblog/assets/js/49.a157cbcb.js"><link rel="prefetch" href="/weblog/assets/js/5.7eff868e.js"><link rel="prefetch" href="/weblog/assets/js/50.9f0506b1.js"><link rel="prefetch" href="/weblog/assets/js/51.8586e26f.js"><link rel="prefetch" href="/weblog/assets/js/52.e307a1be.js"><link rel="prefetch" href="/weblog/assets/js/53.c582cf3c.js"><link rel="prefetch" href="/weblog/assets/js/54.03ed5fe7.js"><link rel="prefetch" href="/weblog/assets/js/55.23116427.js"><link rel="prefetch" href="/weblog/assets/js/56.4af49a61.js"><link rel="prefetch" href="/weblog/assets/js/57.6b889e18.js"><link rel="prefetch" href="/weblog/assets/js/58.f1f0a4ad.js"><link rel="prefetch" href="/weblog/assets/js/59.411b8fe9.js"><link rel="prefetch" href="/weblog/assets/js/6.372c6965.js"><link rel="prefetch" href="/weblog/assets/js/60.2759755d.js"><link rel="prefetch" href="/weblog/assets/js/61.1df9a14d.js"><link rel="prefetch" href="/weblog/assets/js/62.b7f33a0e.js"><link rel="prefetch" href="/weblog/assets/js/63.974dabb9.js"><link rel="prefetch" href="/weblog/assets/js/64.cca16d57.js"><link rel="prefetch" href="/weblog/assets/js/65.586e0e7f.js"><link rel="prefetch" href="/weblog/assets/js/66.48daa51a.js"><link rel="prefetch" href="/weblog/assets/js/67.57ad892a.js"><link rel="prefetch" href="/weblog/assets/js/68.ce0612cf.js"><link rel="prefetch" href="/weblog/assets/js/69.c1abdf8f.js"><link rel="prefetch" href="/weblog/assets/js/7.3ac9f8c9.js"><link rel="prefetch" href="/weblog/assets/js/70.5c27c9e0.js"><link rel="prefetch" href="/weblog/assets/js/71.22eef0c4.js"><link rel="prefetch" href="/weblog/assets/js/72.dc8d97ea.js"><link rel="prefetch" href="/weblog/assets/js/73.788e2dd1.js"><link rel="prefetch" href="/weblog/assets/js/74.d751f795.js"><link rel="prefetch" href="/weblog/assets/js/75.7918ac7c.js"><link rel="prefetch" href="/weblog/assets/js/76.107c27f5.js"><link rel="prefetch" href="/weblog/assets/js/77.c912c850.js"><link rel="prefetch" href="/weblog/assets/js/78.e23be5ae.js"><link rel="prefetch" href="/weblog/assets/js/79.cbeaa75a.js"><link rel="prefetch" href="/weblog/assets/js/8.775ec4e4.js"><link rel="prefetch" href="/weblog/assets/js/80.8c1da72a.js"><link rel="prefetch" href="/weblog/assets/js/81.e042d0c1.js"><link rel="prefetch" href="/weblog/assets/js/82.13420b1a.js"><link rel="prefetch" href="/weblog/assets/js/83.da010ed3.js"><link rel="prefetch" href="/weblog/assets/js/84.421e9b99.js"><link rel="prefetch" href="/weblog/assets/js/85.32c7e90a.js"><link rel="prefetch" href="/weblog/assets/js/9.0fb2fb12.js">
    <link rel="stylesheet" href="/weblog/assets/css/0.styles.570b819f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/weblog/" class="home-link router-link-active"><!----> <span class="site-name">Weblog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试" class="dropdown-title"><span class="title">面试</span> <span class="arrow down"></span></button> <button type="button" aria-label="面试" class="mobile-dropdown-title"><span class="title">面试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/weblog/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/weblog/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/weblog/internet/" class="nav-link">
  网络
</a></li></ul></div></div><div class="nav-item"><a href="/weblog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/weblog/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/weblog/vue/design/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/weblog/typescript/" class="nav-link">
  TypeScript
</a></div><div class="nav-item"><a href="/weblog/git/" class="nav-link">
  Git基本使用
</a></div> <a href="https://github.com/wanghenan12138" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试" class="dropdown-title"><span class="title">面试</span> <span class="arrow down"></span></button> <button type="button" aria-label="面试" class="mobile-dropdown-title"><span class="title">面试</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/weblog/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/weblog/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/weblog/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/weblog/internet/" class="nav-link">
  网络
</a></li></ul></div></div><div class="nav-item"><a href="/weblog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/weblog/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/weblog/vue/design/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/weblog/typescript/" class="nav-link">
  TypeScript
</a></div><div class="nav-item"><a href="/weblog/git/" class="nav-link">
  Git基本使用
</a></div> <a href="https://github.com/wanghenan12138" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>源码目录设计和架构设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/weblog/vue/design/" class="sidebar-link">设计</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Rollup构建版本</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/weblog/vue/rollup/" class="sidebar-link">Rollup基础知识</a></li><li><a href="/weblog/vue/rollup/vue.html" class="sidebar-link">Vue中的Rollup构建</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>从入口到构造函数整体流程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/weblog/vue/entry/" class="sidebar-link">整体流程</a></li><li><a href="/weblog/vue/entry/global.html" class="sidebar-link">initGlobalAPI流程</a></li><li><a href="/weblog/vue/entry/init.html" class="sidebar-link">initMixin流程</a></li><li><a href="/weblog/vue/entry/state.html" class="sidebar-link">stateMixin流程</a></li><li><a href="/weblog/vue/entry/events.html" class="sidebar-link">eventsMixin流程</a></li><li><a href="/weblog/vue/entry/lifecycle.html" class="sidebar-link">lifecycleMixin流程</a></li><li><a href="/weblog/vue/entry/render.html" class="sidebar-link">renderMixin流程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>响应式原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/weblog/vue/reactive/" class="sidebar-link">介绍</a></li><li><a href="/weblog/vue/reactive/prepare.html" class="sidebar-link">前置核心概念</a></li><li><a href="/weblog/vue/reactive/props.html" class="sidebar-link">props处理</a></li><li><a href="/weblog/vue/reactive/methods.html" class="sidebar-link">methods处理</a></li><li><a href="/weblog/vue/reactive/data.html" class="sidebar-link">data处理</a></li><li><a href="/weblog/vue/reactive/computed.html" class="sidebar-link">computed处理</a></li><li><a href="/weblog/vue/reactive/watch.html" class="sidebar-link">watch处理</a></li><li><a href="/weblog/vue/reactive/reactive.html" class="sidebar-link">深入响应式原理</a></li><li><a href="/weblog/vue/reactive/dep.html" class="sidebar-link">依赖收集</a></li><li><a href="/weblog/vue/reactive/notify.html" class="sidebar-link">派发更新</a></li><li><a href="/weblog/vue/reactive/nexttick.html" class="sidebar-link">nextTick实现原理</a></li><li><a href="/weblog/vue/reactive/problem.html" class="sidebar-link">变化侦测注意事项</a></li><li><a href="/weblog/vue/reactive/api.html" class="sidebar-link">变化侦测API实现</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>虚拟DOM和VNode</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/weblog/vue/dom/" class="sidebar-link">虚拟DOM</a></li><li><a href="/weblog/vue/dom/vnode.html" class="sidebar-link">VNode介绍</a></li><li><a href="/weblog/vue/dom/diff.html" class="sidebar-link">Diff算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>组件化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/weblog/vue/component/" class="sidebar-link">介绍</a></li><li><a href="/weblog/vue/component/mount.html" class="sidebar-link">$mount方法</a></li><li><a href="/weblog/vue/component/render.html" class="sidebar-link">render和renderProxy</a></li><li><a href="/weblog/vue/component/createElement.html" class="sidebar-link">createElement</a></li><li><a href="/weblog/vue/component/createComponent.html" class="sidebar-link">createComponent</a></li><li><a href="/weblog/vue/component/merge.html" class="sidebar-link">合并策略</a></li><li><a href="/weblog/vue/component/patch.html" class="sidebar-link">update和patch</a></li><li><a href="/weblog/vue/component/lifecycle.html" class="sidebar-link">组件生命周期</a></li><li><a href="/weblog/vue/component/register.html" class="sidebar-link">组件注册</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>编译原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/weblog/vue/compile/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/weblog/vue/compile/compileToFunctions.html" class="sidebar-link">compileToFunctions</a></li><li><a href="/weblog/vue/compile/parse.html" class="sidebar-link">parse模板解析</a></li><li><a href="/weblog/vue/compile/optimize.html" aria-current="page" class="active sidebar-link">optimize优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/weblog/vue/compile/optimize.html#静态节点类型" class="sidebar-link">静态节点类型</a></li><li class="sidebar-sub-header"><a href="/weblog/vue/compile/optimize.html#标记静态节点" class="sidebar-link">标记静态节点</a></li><li class="sidebar-sub-header"><a href="/weblog/vue/compile/optimize.html#标记静态根节点" class="sidebar-link">标记静态根节点</a></li></ul></li><li><a href="/weblog/vue/compile/codegen.html" class="sidebar-link">codegen代码生成</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>扩展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/weblog/vue/expand/" class="sidebar-link">扩展</a></li><li><a href="/weblog/vue/expand/directive.html" class="sidebar-link">directive指令</a></li><li><a href="/weblog/vue/expand/filter.html" class="sidebar-link">filter过滤器</a></li><li><a href="/weblog/vue/expand/event.html" class="sidebar-link">event事件处理</a></li><li><a href="/weblog/vue/expand/vmodel.html" class="sidebar-link">v-model</a></li><li><a href="/weblog/vue/expand/slot.html" class="sidebar-link">插槽</a></li><li><a href="/weblog/vue/expand/keep-alive.html" class="sidebar-link">Keep-Alive</a></li><li><a href="/weblog/vue/expand/transition.html" class="sidebar-link">Transition</a></li><li><a href="/weblog/vue/expand/transition-group.html" class="sidebar-link">Transition-Group</a></li><li><a href="/weblog/vue/expand/plugin.html" class="sidebar-link">Vue.use插件机制</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="optimize优化"><a href="#optimize优化" class="header-anchor">#</a> optimize优化</h1> <p>在经过<code>parse</code>模板编译完成后，我们可以得到一个<code>ast</code>树形结构，接下来进行<code>optimize</code>优化第二大步骤。这个过程相比较其它两个步骤，是最简单的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./parser/index'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> optimize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./optimizer'</span>

<span class="token keyword">function</span> <span class="token function">baseCompile</span> <span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> CompiledResult <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>优化的目的在于，在编译的时候有些节点自首次渲染完毕后，在后续的派发更新过程中不会随着数据的变动而变动，因此我们在进行节点对比的时候，可以直接跳过这些节点，进一步加快组件渲染的速度。</p> <p>在<code>optimize</code>优化的过程中，它的处理方式是深度遍历<code>ast</code>树形结构，遇到静态节点的时候把它的<code>ast.static</code>属性设置为<code>true</code>。同时对于一个父<code>ast</code>节点来说，当其<code>children</code>子节点全部为静态节点的时候，那么其本身也是一个静态节点，我们把它的<code>ast.staticRoot</code>设置为<code>true</code>。</p> <p>在介绍<code>optimize</code>优化这个章节的时候，我们以下面这个例子为例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div&gt;
    &lt;p&gt;{{msg}}&lt;/p&gt;
    &lt;span&gt;静态节点&lt;/span&gt;
  &lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>在以上例子中，<code>span</code>节点因为其内容是纯文本，因此它的<code>ast.static</code>一定为<code>true</code>。</p> <p>我们回过头来看一下<code>optimize</code>方法的定义，其代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">optimize</span> <span class="token punctuation">(</span><span class="token parameter">root<span class="token operator">:</span> <span class="token operator">?</span>ASTElement<span class="token punctuation">,</span> options<span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token keyword">return</span>
  isStaticKey <span class="token operator">=</span> <span class="token function">genStaticKeysCached</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>staticKeys <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span>
  isPlatformReservedTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isReservedTag <span class="token operator">||</span> no
  <span class="token comment">// first pass: mark all non-static nodes.</span>
  <span class="token function">markStatic</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
  <span class="token comment">// second pass: mark static roots.</span>
  <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个方法中，它首先调用<code>markStatic</code>标记静态节点，然后调用<code>markStaticRoots</code>来标记静态根节点。</p> <h2 id="静态节点类型"><a href="#静态节点类型" class="header-anchor">#</a> 静态节点类型</h2> <p>在<code>markStatic</code>方法中，它首先调用<code>isStatic</code>方法来判断当前<code>ast</code>是否为一个静态节点，其代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">markStatic</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isStatic</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// expression</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// text</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>pre <span class="token operator">||</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>node<span class="token punctuation">.</span>hasBindings <span class="token operator">&amp;&amp;</span> <span class="token comment">// no dynamic bindings</span>
    <span class="token operator">!</span>node<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>node<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span> <span class="token comment">// not v-if or v-for or v-else</span>
    <span class="token operator">!</span><span class="token function">isBuiltInTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// not a built-in</span>
    <span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// not a component</span>
    <span class="token operator">!</span><span class="token function">isDirectChildOfTemplateFor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isStaticKey<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在阅读完<code>isStatic</code>方法后，我们发现静态节点必须满足以下几种情况：</p> <ol><li>带插值(表达式)的文本节点，不是静态节点，例如：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 不是静态节点</span>
<span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;{{msg}}&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><ol start="2"><li>纯文本节点，是静态节点，例如：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 是静态节点</span>
<span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;Hello, Vue.js&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><ol start="3"><li>如果是普通元素节点，并且使用了<code>v-pre</code>指令，则是静态节点，例如：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 是静态节点</span>
<span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div v-pre&gt;{{msg}}&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><ol start="4"><li>如果是普通元素，在没有使用<code>v-pre</code>指令的情况下，还必须同时满足：没有动态绑定属性、没有使用<code>v-if</code>、没有使用<code>v-for</code>、不是内置组件<code>slot/component</code>、是平台保留标签、不是带有<code>v-for</code>的<code>template</code>标签的直接子节点、节点的所有属性的<code>key</code>都是静态<code>key</code>，例如：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 是静态节点</span>
<span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token string">'&lt;div class=&quot;box&quot;&gt;&lt;/div&gt;'</span>
</code></pre></div><h2 id="标记静态节点"><a href="#标记静态节点" class="header-anchor">#</a> 标记静态节点</h2> <p>在分析完<code>isStatic</code>方法后，我们来分析一下<code>markStatic</code>标记静态节点方法的实现原理，其代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">markStatic</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do not make component slot content static. this avoids</span>
    <span class="token comment">// 1. components not able to mutate slot nodes</span>
    <span class="token comment">// 2. static slot content fails for hot-reloading</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">'slot'</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'inline-template'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> block <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block
        <span class="token function">markStatic</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码分析：</p> <ul><li><code>type=2</code>或<code>type=3</code>的时候，代表它们分别是带表达式的插值文本和纯文本，这个时候使用<code>isStatic</code>方法的返回结果，直接标记<code>static</code>属性为<code>true</code>即可。</li> <li>对于<code>type=1</code>，它是普通元素节点的时候，判断逻辑稍微复杂一点。第一步首先需要使用<code>for</code>循环去遍历<code>children</code>子节点，然后在<code>for</code>循环中递归调用<code>markStatic</code>方法，以达到深度遍历并标记子节点的目的。在这个过程中，唯一一个值得注意的地方就是，在对<code>children</code>子节点标记完毕后，会根据子节点的<code>static</code>属性来设置父节点的<code>static</code>属性。只要有一个子节点的<code>static</code>属性不为<code>true</code>，那么父节点也一定不为<code>true</code>。第二步，如果当前节点有<code>v-if/v-else-if/v-else</code>等指令，由于这些节点并不会保存在<code>children</code>数组中，而是在<code>node.ifConditions</code>属性下面，因此我们需要遍历<code>ifConditions</code>数组，来递归标记子节点。同样的，在标记完子节点后，我们需要根据子节点的<code>static</code>来同步更新父节点的<code>static</code>。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> showMsg <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div&gt;
    &lt;div v-if=&quot;showMsg&quot;&gt;show&lt;/div&gt;
    &lt;div v-else=&quot;showMsg&quot;&gt;not show&lt;/div&gt;
  &lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  ifConditions<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> exp<span class="token operator">:</span> <span class="token string">'showMsg'</span><span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token string">'div的ast节点'</span> <span class="token punctuation">}</span>，
    <span class="token punctuation">{</span> exp<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token string">'div的ast节点'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="标记静态根节点"><a href="#标记静态根节点" class="header-anchor">#</a> 标记静态根节点</h2> <p>在介绍完标记静态节点后，我们接着要介绍标记静态根节点<code>markStaticRoots</code>方法，其代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">markStaticRoots</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> ASTNode<span class="token punctuation">,</span> isInFor<span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">||</span> node<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>staticInFor <span class="token operator">=</span> isInFor
    <span class="token punctuation">}</span>
    <span class="token comment">// For a node to qualify as a static root, it should have children that</span>
    <span class="token comment">// are not just static text. Otherwise the cost of hoisting out will</span>
    <span class="token comment">// outweigh the benefits and it's better off to just always render it fresh.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>
      node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isInFor <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>node<span class="token punctuation">.</span>for<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">,</span> isInFor<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到，在<code>markStaticRoots</code>方法中它对于<code>children</code>子节点和带<code>v-if/v-else-if/v-else</code>等指令的处理过程是类似的，我们省略这部分内容重复的介绍。</p> <p>我们来看下面这段有意思的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// For a node to qualify as a static root, it should have children that</span>
<span class="token comment">// are not just static text. Otherwise the cost of hoisting out will</span>
<span class="token comment">// outweigh the benefits and it's better off to just always render it fresh.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>
  node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
  node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们从注释中也可以看出来，如果当前节点<code>static</code>属性为<code>true</code>了，要标记它为静态根节点的话，还必须满足它的子节点不能只有一个纯文本节点，因为这样做其优化成本要大于其收益。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/17/2021, 5:31:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/weblog/vue/compile/parse.html" class="prev">
        parse模板解析
      </a></span> <span class="next"><a href="/weblog/vue/compile/codegen.html">
        codegen代码生成
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/weblog/assets/js/app.eefccb8e.js" defer></script><script src="/weblog/assets/js/2.dbfb7c6a.js" defer></script><script src="/weblog/assets/js/44.47622ca8.js" defer></script>
  </body>
</html>
